# AudioLink × Particle × Udon 要件定義 v1

## 概要 / 目的
- パーティクル（Shuriken）の見た目はシェーダ中心（Poiyomi / 自作HLSL）。
- UdonSharp は係数・プリセット調整と軽度の挙動モジュレーション（発生数/速度/サイズ）に限定。
- AudioLink の反応を安定・高パフォーマンスで提供し、PC（Desktop/VR）で快適に動作させる。

## 対象環境
- Unity: 2022.3.22f1
- VRChat: SDK3 最新 / Worlds（Built‑in RP）
- プラットフォーム: PC（Desktop/VR）
- 実装: UdonSharp 前提（C#）。Udon Graph は最小限の UI トグル/スイッチのみ。

## 前提 / 制約
- VCC で AudioLink を導入。
- シーンに `AudioLink` と `AudioLinkController` を配置し、`AudioSource` を割り当て。「Link all sound reactive objects to this AudioLink」を実行。
- `_AudioTexture` は GPU 側のグローバルテクスチャ。CPU（Udon）での読み戻しは行わない。
- AudioLink 設定: 標準 `_AudioTexture` 参照を使用。「Audio Data（実験的）」は初期 OFF（必要に応じて将来ONを検討）。

## シェーダ / マテリアル要件
- Poiyomi Toon 9.x を使用。AudioLink モジュールを有効化し、帯域割当・スムージング等はマテリアル UI で設定。
- 自作 HLSL を併用し、`_AudioTexture` を直接サンプルして発光・色ブレンド・頂点変位を実装。
- 自作 HLSL のプロパティ（例）:
  - `_BaseColor (Color)` 基本色
  - `_EmissionColor (Color)` 発光色
  - `_EmissionGain (Range 0–5)` 発光強度
  - `_AL_Enable (Float 0/1)` AudioLink反映 ON/OFF
  - `_AL_Band (Float 0=Bass,1=LowMid,2=HighMid,3=Treble)` 参照帯域
  - `_AL_Gain (Range 0–4)` オーディオ入力のゲイン
  - `_AL_Smooth (Range 0–1)` 平滑化（EMA係数）
  - `_DisplaceAmp (Range 0–1)` 頂点変位量（任意）
  - `_ColorA / _ColorB (Color)` 帯域反応時の色ブレンド用
  - 入力: `_AudioTexture (2D, Global)` AudioLinkのオーディオデータ
- 注意: Poiyomi の内部プロパティ名は版数で変わり得るため「内部名固定依存」を避け、外部公開 UI と MaterialPropertyBlock（MPB）でのみ制御する。

## UdonSharp コンポーネント要件
- ALPresetController
  - 目的: プリセット（Calm/Default/Hype）による `_AL_Gain` / `_AL_Smooth` / `_EmissionGain` / `masterGain` 等の一括調整。
  - SafeMode（点滅抑制）や BeatPulse ON/OFF の切替を提供。
  - 複数 Renderer へ MPB を適用。全値クランプ・更新頻度抑制（フレーム毎再割当禁止）。
- ALParticleModulator
  - 目的: ParticleSystem の `Emission.rateOverTime` / `Main.startSpeed` / `Main.startSize` を「簡易音量指標」で軽度にモジュレーション。
  - EMA スムージング: 0.12–0.18（初期 0.15）。0–1 に正規化後、係数で拡大。全てクランプ。
  - Audio Data（実験的）OFFの前提で、粗い音量が得られない環境では穏やかなアイドリングにフォールバック。
- ALUIController（Udon Graph 最小）
  - 目的: 非エンジニア向けのワールド内パネル。
  - 操作: プリセット、MasterGain、EmissionGain、Smooth、SafeMode、BeatPulse。

## UI 要件（ワールド内簡易パネル）
- プリセット: Calm / Default / Hype
- スライダー: MasterGain、EmissionGain、Smooth
- トグル: SafeMode（点滅抑制）、BeatPulse ON/OFF

## 帯域マッピング（推奨）
- Bass（低音）: Emission.rate、StartSize、発光
- LowMid（中低）: 色ブレンド（`_ColorA`↔`_ColorB`）/ 微揺らぎ
- HighMid（中高）: StartSpeed
- High（高音）: 別 PS のスパークレート
- Beat（拍）: 短パルスで Burst / Rim 強調（主にシェーダ側）

## 初期値 / 範囲
- 初期ゲイン: `masterGain = 1.0`、`_AL_Gain = 1.5`
- 平滑化: `_AL_Smooth = 0.15`（EMA: 0.12–0.18）
- 出力: 0–1 に正規化 → 係数で拡大。全値 `Clamp`。

## 同期要件
- 反応はローカル主体（演出）。
- 必要最小限の同期: `Preset (Enum)` / `MasterGain (float)` / `SafeMode (bool)` のみ。

## フォールバック
- 無音 / AudioLink 無効時: 穏やかな発光と低レートでアイドリング（停止しない）。

## 音源
- 既定: `AudioSource`（BGM/環境音）。
- 将来拡張: `VideoPlayer` 対応（切替フラグを準備）。

## 非機能要件
- パフォーマンス（PC）: 総粒子 ≤ 15k、描画マテリアル ≤ 3、発光は中程度まで。
- GCゼロ: 参照キャッシュ、モジュール再取得禁止、毎フレームの割当回避。
- 安全性/視認性: SafeMode で点滅抑制。Smoothing/Clamp を徹底し眩しさやちらつきを抑える。
- 保守性/拡張性: MPB と公開 UI のみ依存。Poiyomi 内部名変動に耐性。Quest/VideoPlayer への拡張ポイント確保。

## 受け入れ基準
- AudioLink メータが動作し、Poiyomi / 自作HLSL 双方で視覚反応が確認できる。
- プリセット/スライダー/トグル操作が即時に視覚へ反映される。SafeMode で点滅が顕著に低減。
- ALParticleModulator は無音環境でも破綻せずアイドリング。実験的機能 ON 時に帯域連動の変化が得られる。
- パフォーマンス目標内（フレーム安定、GC発生が観測されない/極小）。

## 参照
- AudioLink 公式: https://audiolink.dev
- AudioLink GitHub: https://github.com/llealloo/vrc-udon-audio-link

