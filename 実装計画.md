# AudioLink × Particle × Udon 実装計画 v1

## スコープと成果物
- シェーダ（自作HLSL最小機能）: `_AudioTexture` をサンプルし、発光 / 色ブレンド / 任意の頂点揺らぎに反映。
- Poiyomi マテリアル設定: AudioLink モジュール有効化、帯域割当、スムージング設定。必要箇所は MPB 制御。
- UdonSharp 2種:
  - `ALPresetController`: プリセット/ゲイン/スムーズ/SafeMode/BeatPulse 管理（MPB 適用）。
  - `ALParticleModulator`: Emission/StartSpeed/StartSize の軽度モジュレーション。
- UI（Udon Graph 最小）: プリセット/スライダー/トグルの簡易パネル。
- Prefab 化: 一式を再利用可能にグルーピング。
- ドキュメント: `agent.md` 最小追補（プロパティ表 & 調整手順）。

## タスク分解 / 順序
1) セットアップ（0.5h）
   - VCC で AudioLink 導入、Poiyomi 9.x 導入。
   - シーンに `AudioLink` / `AudioLinkController` を配置、`AudioSource` を割当。
   - 「Link all sound reactive objects…」実行、メータ動作確認。

2) 自作HLSL（2.5–4h）
   - `_AudioTexture` サンプリングヘルパー（帯域/履歴の座標規約対応）。
   - プロパティ実装（`_AL_Enable/_AL_Band/_AL_Gain/_AL_Smooth/_EmissionGain/_DisplaceAmp/_ColorA/_ColorB`）。
   - Emission/色ブレンド/頂点揺らぎの反応パス。`saturate`/カーブ/スムージングでちらつき抑制。
   - MPB 対応（係数やプリセット値の外部反映）。

3) Poiyomi 設定（1h）
   - マテリアル作成、AudioLink モジュール ON、帯域割当と Smoothing 調整。
   - MPB で外部制御する公開パラメータを確認し接続（内部名固定依存禁止）。

4) UdonSharp: ALPresetController（1.5h）
   - プリセット（Calm/Default/Hype）定義。`masterGain/_AL_Gain/_AL_Smooth/_EmissionGain` のセット。SafeMode/BeatPulse 管理。
   - Renderer 配列への MPB 適用。値域クランプ・更新頻度抑制・参照キャッシュ。

5) UdonSharp: ALParticleModulator（2–3h）
   - ParticleSystem の参照キャッシュとモジュール取得（Emission/Main/Optional: Noise）。
   - EMA（0.12–0.18、初期 0.15）、0–1 正規化、係数、Clamp 実装。フレーム毎 alloc 回避。
   - Audio Data（実験的）OFF時はアイドリング。ON時の帯域連動はオプション（+1h）。

6) UI（Udon Graph 最小）（1h）
   - プリセット/スライダー（MasterGain/EmissionGain/Smooth）/トグル（SafeMode/BeatPulse）を UdonSharp 公開変数/メソッドへ結線。

7) 結線 / Prefab 化（1h）
   - シェーダ/マテリアル/スクリプト/パネルをプレハブ化。差し替え容易に。

8) 検証 / チューニング（1.5–2h）
   - 実音源（BGM/環境音）で反応確認。ちらつき/眩しさ/上限をチューニング。
   - プロファイラでフレーム/GC 確認。粒子総数/マテリアル数の遵守確認。

9) ドキュメント追補（1h）
   - `agent.md` にプロパティ表と調整手順を最小追記。

合計目安: 12–14h（帯域CPU連動を含める場合は +1h）。

## ファイル構成案
- `Assets/Scripts/UdonSharp/ALPresetController.cs`
- `Assets/Scripts/UdonSharp/ALParticleModulator.cs`
- `Assets/Scripts/UdonGraph/ALUIController.asset`
- `Assets/Shaders/ALReactiveParticle.shader`
- `Assets/Materials/Particles/*`
- `Assets/Prefabs/AL_*`

## 実装ガイドライン
- MPB（MaterialPropertyBlock）での更新を徹底。Renderer/Material の動的インスタンス化禁止。
- 参照/モジュールは Start/Awake でキャッシュ。毎フレームの `new`/LINQ/String 操作は禁止。
- 値域はすべて `Mathf.Clamp`。視認性優先で EMA/ヒステリシス/カーブを活用。
- 更新頻度は必要最小限（例: 反応係数は `LateUpdate`、UI操作時のみ再適用など）。

## 依存関係 / 前提
- AudioLink の帯域・座標規約準拠。`_AudioTexture` は GPU グローバル。
- Audio Data（実験的）初期 OFF。ON 時の拡張ポイントは `ALParticleModulator` に保持。
- Poiyomi 内部名変動に依存しない設計（公開 UI/MPB のみ）。

## リスク / 対策
- 過度な点滅/眩しさ: SafeMode、Smoothing、発光上限/カーブ。
- パフォーマンス悪化: 粒子 ≤ 15k、マテリアル ≤ 3、毎フレーム alloc/モジュール再取得禁止。
- 依存バージョン差: Poiyomi 9.x で検証し、将来差分は MPB レイヤで吸収。

## マイルストーン
- M1: HLSL 最小反応 + Poiyomi 設定完了（目視で反応確認）。
- M2: UdonSharp 2種 + UI 接続（プリセット/ゲイン操作が反映）。
- M3: Prefab 化 + 検証（受け入れ基準達成）。
- M4: ドキュメント追補（agent.md 最小追記）。

## 検証項目 / 受け入れ手順
- シーンで AudioLink メータが動作。Poiyomi/自作HLSL の反応を確認。
- プリセット/スライダー/トグルの即時反映。SafeMode で点滅低減を視認。
- ALParticleModulator が無音で破綻せずアイドリング。実験機能 ON で帯域連動変化を確認。
- プロファイラでフレームの安定、GC 発生が無/極小であることを確認。

## 今後の拡張
- VideoPlayer 入力の切替対応、Beat 抽出の強化、パルス駆動のプリセット追加。
- Quest 最適化（粒子≤2,000、発光控えめ、ソフトパーティクル OFF、圧縮）。
- エディタツール（プリセット編集 UI、プロファイル保存/読み込み）。

